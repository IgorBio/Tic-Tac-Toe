# Задание 4: Web-слой - Реализация завершена ✓

## Обзор

Web-слой для проекта Крестики-Нолики успешно реализован согласно всем требованиям задания 4.

## Выполненные задачи

### ✅ 4.1 Модели игрового поля и текущей игры

Созданы модели для web-слоя с поддержкой JSON сериализации:

**Файлы:**
- `web/model/game_board.py` - Модель игрового поля
- `web/model/game.py` - Модель текущей игры

**Функционал:**
- `to_dict()` - Сериализация в JSON-совместимый формат
- `from_dict()` - Десериализация из JSON
- Валидация данных при создании
- Поддержка UUID для идентификации игр

### ✅ 4.2 Мапперы domain↔web

Реализованы двунаправленные мапперы для преобразования между слоями:

**Файлы:**
- `web/mapper/game_board_mapper.py` - Маппер для игрового поля
- `web/mapper/game_mapper.py` - Маппер для игры

**Методы:**
- `to_web()` - Преобразование из domain в web
- `to_domain()` - Преобразование из web в domain

### ✅ 4.3 Контроллер с использованием Flask

Создан REST API контроллер с методом POST /game/{uuid}:

**Файлы:**
- `web/route/game_controller.py` - Контроллер с обработчиками
- `web/module/app.py` - Flask приложение

**Endpoint:**
```
POST /game/{uuid}
```

**Функционал:**
- Принимает ход пользователя
- Валидирует ход через domain service
- Вычисляет ход компьютера (Minimax)
- Возвращает обновленное состояние игры
- Обрабатывает завершение игры

### ✅ 4.4 Обработка некорректных данных

Реализована комплексная обработка ошибок с описательными сообщениями:

**Типы ошибок:**
1. **Невалидный JSON** (400)
   - Отсутствует тело запроса
   - Некорректный формат JSON

2. **Ошибки UUID** (400)
   - Несоответствие UUID в URL и теле запроса
   - Невалидный формат UUID
   - Отсутствует UUID в теле запроса

3. **Невалидные ходы** (400)
   - Изменено несколько клеток за один ход
   - Изменены предыдущие ходы
   - Ход не обнаружен
   - Неправильный игрок (компьютер вместо человека)

4. **Ошибки состояния игры** (400)
   - Игра уже завершена

5. **Внутренние ошибки** (500)
   - Неожиданные исключения

**Пример ответа с ошибкой:**
```json
{
  "error": "Invalid move",
  "message": "Multiple cells changed: 2. Only one move allowed per turn."
}
```

### ✅ 4.5 Поддержка нескольких игр одновременно

Реализована поддержка множественных одновременных игр:

**Характеристики:**
- Каждая игра идентифицируется уникальным UUID
- Независимые состояния игр
- Потокобезопасное хранилище (из datasource-слоя)
- Нет общего состояния между играми
- Масштабируемая архитектура

### ✅ 4.6 Разделение файлов

Все модели, интерфейсы и реализации находятся в отдельных файлах согласно требованиям.

## Структура проекта

```
web/
├── __init__.py
├── README.md                    # Быстрый старт
├── WEB_LAYER.md                 # Полная документация
├── IMPLEMENTATION_SUMMARY.md    # Итоговый отчет
│
├── model/                       # Модели для web-слоя
│   ├── __init__.py
│   ├── game_board.py           # Модель игрового поля
│   └── game.py                 # Модель игры
│
├── mapper/                      # Мапперы domain↔web
│   ├── __init__.py
│   ├── game_board_mapper.py    # Маппер игрового поля
│   └── game_mapper.py          # Маппер игры
│
├── route/                       # REST API контроллеры
│   ├── __init__.py
│   └── game_controller.py      # Контроллер игры
│
└── module/                      # Flask приложение
    ├── __init__.py
    └── app.py                  # Настройка Flask

main.py                          # Точка входа приложения

tests/
└── web/                         # Тесты web-слоя
    ├── __init__.py
    └── test_web.py

examples/
└── api_examples.py              # Примеры использования API
```

## API Документация

### POST /game/{uuid}

Отправить ход и получить ответ компьютера.

**Запрос:**
```json
{
  "uuid": "123e4567-e89b-12d3-a456-426614174000",
  "board": [
    [0, 0, 0],
    [0, 1, 0],
    [0, 0, 0]
  ]
}
```

**Успешный ответ (200):**
```json
{
  "uuid": "123e4567-e89b-12d3-a456-426614174000",
  "board": [
    [2, 0, 0],
    [0, 1, 0],
    [0, 0, 0]
  ]
}
```

**Ответ при завершении игры (200):**
```json
{
  "uuid": "123e4567-e89b-12d3-a456-426614174000",
  "board": [
    [1, 1, 1],
    [2, 2, 0],
    [0, 0, 0]
  ],
  "game_over": true,
  "winner": "Human wins (X)"
}
```

**Значения клеток:**
- `0` - Пустая клетка
- `1` - X (человек)
- `2` - O (компьютер)

### GET /health

Проверка состояния сервиса.

**Ответ:**
```json
{
  "status": "ok"
}
```

## Использование

### Установка зависимостей

```bash
pip install flask
```

### Запуск сервера

```bash
python main.py
```

Сервер будет доступен по адресу `http://localhost:5000`

### Примеры использования

#### С использованием curl

```bash
curl -X POST http://localhost:5000/game/123e4567-e89b-12d3-a456-426614174000 \
  -H "Content-Type: application/json" \
  -d '{
    "uuid": "123e4567-e89b-12d3-a456-426614174000",
    "board": [[0, 0, 0], [0, 1, 0], [0, 0, 0]]
  }'
```

#### С использованием Python

```python
import requests
from uuid import uuid4

game_id = uuid4()

response = requests.post(
    f'http://localhost:5000/game/{game_id}',
    json={
        'uuid': str(game_id),
        'board': [[0, 0, 0], [0, 1, 0], [0, 0, 0]]
    }
)

print(response.json())
```

Полные примеры использования API находятся в файле `examples/api_examples.py`.

## Тестирование

### Запуск тестов

```bash
python tests/web/test_web.py
```

### Результаты тестов

Все тесты пройдены успешно:
- ✓ Тесты моделей (сериализация/десериализация)
- ✓ Тесты мапперов (преобразование domain ↔ web)
- ✓ Тесты JSON сериализации
- ✓ Тесты валидации UUID
- ✓ Тесты обработки ошибок

## Ключевые особенности

### 1. REST API
- Стандартные REST соглашения
- JSON запросы/ответы
- Корректные HTTP статус коды
- Чистый HTTP интерфейс

### 2. Валидация
- Проверка тела запроса
- Валидация формата UUID
- Проверка состояния доски
- Валидация ходов (через domain service)

### 3. Обработка ошибок
- Детальные сообщения об ошибках
- Понятные описания для пользователя
- Не раскрывает внутренние детали
- Логирование ошибок

### 4. Архитектура
- Разделение слоев (web ↔ domain)
- Мапперы для границ слоев
- Контроллер координирует операции
- Нет бизнес-логики в web-слое

### 5. Масштабируемость
- Потокобезопасные операции
- Поддержка множества игр
- Stateless контроллеры
- Готовность к горизонтальному масштабированию

## Интеграция с другими слоями

### Domain Layer
- Контроллер использует интерфейс `GameService`
- Мапперы преобразуют между моделями web и domain
- Чистый поток зависимостей: Web → Domain

### Datasource Layer
- Через domain service и repository
- Потокобезопасное хранилище
- Независимые состояния игр

### DI Layer (будущее)
- Service будет инъецирован через DI контейнер
- Конфигурация вместо прямой инстанциации
- Упрощение тестирования

## Документация

1. **README.md** - Быстрый старт и справка по API
2. **WEB_LAYER.md** - Полная документация:
   - Детальная справка по API
   - Примеры запросов/ответов
   - Руководство по обработке ошибок
   - Рекомендации по тестированию
   - Лучшие практики
   - Планы развития

3. **IMPLEMENTATION_SUMMARY.md** - Итоговый отчет по реализации

## Соответствие требованиям

### Задание 4.1 ✓
- [x] Описаны модели игрового поля
- [x] Описаны модели текущей игры
- [x] Модели в отдельных файлах

### Задание 4.2 ✓
- [x] Реализованы мапперы domain↔web
- [x] Мапперы в отдельных файлах
- [x] Двунаправленное преобразование

### Задание 4.3 ✓
- [x] Контроллер с использованием Flask
- [x] Метод POST /game/{uuid}
- [x] Отправка/получение обновленной игры
- [x] Контроллер в отдельном файле

### Задание 4.4 ✓
- [x] Обработка некорректных данных
- [x] Возврат ошибок с описанием
- [x] Детальные сообщения об ошибках

### Задание 4.5 ✓
- [x] Поддержка нескольких игр одновременно
- [x] Независимые состояния игр
- [x] Потокобезопасность

### Задание 4.6 ✓
- [x] Модели, интерфейсы, реализации в разных файлах
- [x] Четкая структура проекта

## Следующие шаги

Web-слой полностью готов к:
1. **Интеграции с DI-слоем** (Задание 5)
2. **Развертыванию** на production сервере
3. **Созданию Frontend** приложения
4. **Расширению функционала** (история игр, статистика)
5. **Документированию API** (Swagger/OpenAPI)

## Заключение

Все требования задания 4 успешно выполнены. Web-слой предоставляет полнофункциональный REST API для игры в крестики-нолики с:
- Валидацией данных
- Обработкой ошибок
- Поддержкой множественных игр
- Чистой архитектурой
- Полной документацией

Реализация готова к интеграции с DI-слоем и развертыванию.
